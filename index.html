<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>QR Code Attendance Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f9f9f9;
        }
        h1 {
            text-align: center;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }
        th {
            background-color: #4CAF50;
            color: white;
        }
        #controls {
            text-align: center;
            margin: 20px 0;
        }
        input, button {
            padding: 10px;
            margin: 5px;
        }
        #reader {
            display: none;
            justify-content: center;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>QR Code Attendance Dashboard</h1>

    <div id="controls">
        <input type="text" id="manualName" placeholder="Enter name manually">
        <button onclick="addManualRecord()">Add Manually</button>
        <button onclick="toggleQRScanner()">Scan QR Code</button>
        <button onclick="exportToCSV()">Download Excel</button>
    </div>

    <div id="reader"></div>

    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Date</th>
                <th>Time</th>
            </tr>
        </thead>
        <tbody id="attendanceList">
            <!-- Attendance records will appear here -->
        </tbody>
    </table>

    <script src="https://unpkg.com/html5-qrcode"></script>
    <script>
        let qrCodeScanner;
        let scannedRecords = new Set();

        // Helper function to get today's date in YYYY-MM-DD format
        function getTodayDate() {
            const today = new Date();
            return today.toISOString().split('T')[0];
        }

        // Reset scanned records at 6 AM daily
        function resetDailyAt6AM() {
            const now = new Date();
            const nextReset = new Date();
            nextReset.setHours(6, 0, 0, 0);

            if (now >= nextReset) {
                nextReset.setDate(nextReset.getDate() + 1);
            }

            const timeUntilReset = nextReset - now;

            setTimeout(() => {
                scannedRecords.clear();
                resetDailyAt6AM();
            }, timeUntilReset);
        }

        resetDailyAt6AM();

        // Load records from Local Storage
        window.onload = function() {
            const records = JSON.parse(localStorage.getItem('attendanceRecords')) || [];
            records.forEach(record => {
                addRow(record.name, record.date, record.time);
                if (record.date === getTodayDate()) {
                    scannedRecords.add(record.name); // Track scanned records for today
                }
            });
        };

        function addRow(name, date, time) {
            const table = document.getElementById('attendanceList');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `<td>${name}</td><td>${date}</td><td>${time}</td>`;
            table.appendChild(newRow);
        }

        function saveRecord(name, date, time) {
            const records = JSON.parse(localStorage.getItem('attendanceRecords')) || [];
            records.push({ name, date, time });
            localStorage.setItem('attendanceRecords', JSON.stringify(records));
        }

        function addRecordAndSave(name) {
            const today = getTodayDate();
            if (scannedRecords.has(name)) {
                alert("This QR code has already been scanned today.");
                return;
            }

            scannedRecords.add(name);
            const now = new Date();
            const time = now.toLocaleTimeString();

            addRow(name, today, time);
            saveRecord(name, today, time);
        }

        function addManualRecord() {
            const nameInput = document.getElementById('manualName');
            const name = nameInput.value.trim();
            if (name) {
                addRecordAndSave(name);
                nameInput.value = '';
            } else {
                alert("Please enter a name.");
            }
        }

        function toggleQRScanner() {
            const readerDiv = document.getElementById('reader');
            if (readerDiv.style.display === 'none') {
                readerDiv.style.display = 'flex';
                startQRScanner();
            } else {
                readerDiv.style.display = 'none';
                if (qrCodeScanner) qrCodeScanner.stop();
            }
        }

        function startQRScanner() {
            qrCodeScanner = new Html5Qrcode("reader");

            navigator.mediaDevices.enumerateDevices().then((devices) => {
                const backCamera = devices.find(device => device.kind === 'videoinput' && device.label.toLowerCase().includes('back'));
                const cameraConfig = backCamera ? { deviceId: backCamera.deviceId } : { facingMode: "environment" };

                qrCodeScanner.start(
                    cameraConfig,
                    { fps: 10, qrbox: 350 }, // Increased size of scanner
                    (decodedText) => {
                        addRecordAndSave(decodedText); // Automatically records attendance
                    },
                    (errorMessage) => {
                        console.log(`QR Scan Error: ${errorMessage}`);
                    }
                ).catch(err => console.error("QR Scanner Error: ", err));
            });
        }

        function exportToCSV() {
            const records = JSON.parse(localStorage.getItem('attendanceRecords')) || [];
            let csvContent = "data:text/csv;charset=utf-8,Name,Date,Time\n";

            records.forEach(record => {
                csvContent += `${record.name},${record.date},${record.time}\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "attendance_records.csv");
            document.body.appendChild(link);
            link.click();
        }
    </script>
</body>
</html>
